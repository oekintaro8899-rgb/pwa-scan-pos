<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scan Pos Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; padding: 20px }
    select, button { width: 100%; padding: 12px; margin: 10px 0 }
    #reader { width: 100%; margin-top: 10px }
    #status { margin-top: 15px; font-weight: bold }
    .hidden { display: none }
  </style>
</head>

<body>

<h2>Scan Pos Kerja</h2>

<!-- LOGIN -->
<div id="loginBox">
  <select id="loginPetugas">
    <option value="">-- Pilih Petugas --</option>
  </select>
  <button onclick="login()">Login</button>
</div>

<!-- SCAN -->
<div id="scanBox" class="hidden">
  <p><b id="petugasInfo"></b></p>
  <button onclick="startScan()">Scan QR</button>
  <div id="reader"></div>
  <p id="status"></p>
</div>

<script>
/* ========== CONFIG ========== */
const SUPABASE_URL = "https://jaiemnaqapcvmvvwqpct.supabase.co";
const SUPABASE_KEY = "sb_publishable_v1Nt74_3aNhVJKSY8v5I7Q_0OSjAb9C";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ========== DEVICE ID ========== */
function getDeviceId() {
  let id = localStorage.getItem("device_id");
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem("device_id", id);
  }
  return id;
}

/* ========== LOAD PETUGAS (LOGIN) ========== */
async function loadLoginPetugas() {
  const { data } = await db
    .from("petugas")
    .select("id_petugas,nama")
    .eq("status", "Aktif");

  const sel = document.getElementById("loginPetugas");
  data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id_petugas;
    o.text = `${p.id_petugas} - ${p.nama}`;
    sel.add(o);
  });
}
loadLoginPetugas();

/* ========== LOGIN ========== */
async function login() {
  const idPetugas = document.getElementById("loginPetugas").value;
  if (!idPetugas) {
    alert("Pilih petugas");
    return;
  }

  const deviceId = getDeviceId();

  const { error } = await db
    .from("petugas")
    .update({ device_id: deviceId })
    .eq("id_petugas", idPetugas)
    .is("device_id", null);
    .select();

  if (error) {
    alert("Petugas ini sudah login di HP lain");
    return;
  }

   // â›” TIDAK ADA BARIS TER-UPDATE = SUDAH DIPAKAI
  if (!data || data.length === 0) {
    alert("Petugas ini sudah terdaftar di HP lain");
    return;
  }

  localStorage.setItem("id_petugas", idPetugas);
  showScan();
}

/* ========== AUTO LOGIN ========== */
async function showScan() {
  const idPetugas = localStorage.getItem("id_petugas");
  if (!idPetugas) return;

  const { data } = await db
    .from("petugas")
    .select("nama")
    .eq("id_petugas", idPetugas)
    .single();

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("scanBox").classList.remove("hidden");
  document.getElementById("petugasInfo").innerText =
    "Petugas: " + idPetugas + " - " + data.nama;
}
showScan();

/* ========== HITUNG JARAK ========== */
function hitungJarak(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
    Math.sin(dLon/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ========== SCAN ========== */
function startScan() {
  const idPetugas = localStorage.getItem("id_petugas");
  if (!idPetugas) {
    alert("Belum login");
    return;
  }

  const html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrText => {
      html5QrCode.stop();

      navigator.geolocation.getCurrentPosition(
        async pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          const { data: posKerja } = await db
            .from("pos_kerja")
            .select("*")
            .eq("id_pos", qrText)
            .single();

          if (!posKerja) {
            alert("Pos tidak ditemukan");
            return;
          }

          const jarak = hitungJarak(
            lat, lon,
            posKerja.latitude,
            posKerja.longitude
          );

          const valid = jarak <= posKerja.toleransi;

          await db.from("log_scan").insert({
            waktu_scan: new Date().toISOString(),
            id_petugas: idPetugas,
            id_pos: qrText,
            lat_scan: lat,
            long_scan: lon,
            jarak: jarak,
            valid: valid
          });

          document.getElementById("status").innerText =
            `Scan tersimpan | Jarak: ${jarak.toFixed(1)} m | Valid: ${valid}`;
        },
        err => alert("GPS gagal: " + err.message),
        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    }
  );
}
</script>

</body>
</html>
