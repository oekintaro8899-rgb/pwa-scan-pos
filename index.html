<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scan Pos Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; padding: 20px }
    select, button { width: 100%; padding: 12px; margin: 10px 0 }
    #reader { width: 100%; margin-top: 10px }
    #status { margin-top: 15px; font-weight: bold }
  </style>
</head>

<body>

<h2>Scan Pos Kerja</h2>

<select id="petugas">
  <option value="">-- Pilih Petugas --</option>
</select>

<button onclick="startScan()">Scan QR</button>

<div id="reader"></div>
<p id="status"></p>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://jaiemnaqapcvmvvwqpct.supabase.co";
const SUPABASE_KEY = "sb_publishable_v1Nt74_3aNhVJKSY8v5I7Q_0OSjAb9C";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ================= LOAD PETUGAS ================= */
async function loadPetugas() {
  const { data, error } = await db
    .from("petugas")
    .select("id_petugas,nama")
    .eq("status", "Aktif");

  if (error) {
    alert(error.message);
    return;
  }

  const sel = document.getElementById("petugas");
  data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id_petugas;
    o.text = `${p.id_petugas} - ${p.nama}`;
    sel.add(o);
  });
}
loadPetugas();

/* ================= HITUNG JARAK ================= */
function hitungJarak(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ================= START SCAN ================= */
function startScan() {
  const idPetugas = document.getElementById("petugas").value;
  if (!idPetugas) {
    alert("Pilih petugas terlebih dahulu");
    return;
  }

  const html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async qrText => {
      html5QrCode.stop();

      document.getElementById("status").innerText =
        "QR terbaca: " + qrText + " | Mengambil lokasi...";

      navigator.geolocation.getCurrentPosition(
        async pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          /* Ambil data pos kerja */
          const { data: posKerja, error } = await db
            .from("pos_kerja")
            .select("*")
            .eq("id_pos", qrText)
            .single();

          if (error || !posKerja) {
            alert("Pos kerja tidak ditemukan");
            return;
          }

          const jarak = hitungJarak(
            lat, lon,
            posKerja.latitude,
            posKerja.longitude
          );

          const valid = jarak <= posKerja.toleransi;

          /* Simpan log */
          const { error: insertError } = await db
            .from("log_scan")
            .insert({
              waktu_scan: new Date().toISOString(),
              id_petugas: idPetugas,
              id_pos: qrText,
              lat_scan: lat,
              long_scan: lon,
              jarak: jarak,
              valid: valid
            });

          if (insertError) {
            alert("Gagal simpan: " + insertError.message);
            return;
          }

          document.getElementById("status").innerText =
            `Scan tersimpan | Jarak: ${jarak.toFixed(1)} m | Valid: ${valid}`;
        },
        err => {
          alert("GPS gagal: " + err.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    }
  );
}
</script>

</body>
</html>
