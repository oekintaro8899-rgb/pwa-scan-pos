<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scan Pos Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, button { width: 100%; padding: 12px; margin: 10px 0; }
    #reader { width: 100%; margin-top: 10px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>

<body>

<h2>Scan Pos Kerja</h2>

<select id="petugas">
  <option value="">Pilih Petugas</option>
</select>

<button onclick="startScan()">Scan QR Code</button>

<div id="reader"></div>
<p id="status"></p>

<script>
console.log("SCRIPT JALAN");

// ================= SUPABASE =================
const SUPABASE_URL = "https://jaiemnaqapcvmvvwqpct.supabase.co";
const SUPABASE_KEY = "sb_publishable_v1Nt74_3aNhVJKSY8v5I7Q_0OSjAb9C";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// ================= HITUNG JARAK =================
function hitungJarak(lat1, lon1, lat2, lon2) {
  const R = 6371000; // meter
  const toRad = x => x * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

// ================= LOAD PETUGAS =================
async function loadPetugas() {
  const { data, error } = await db
    .from("petugas")
    .select("id_petugas,nama")
    .eq("status", "Aktif");

  if (error) {
    alert("Gagal load petugas: " + error.message);
    console.error(error);
    return;
  }

  const sel = document.getElementById("petugas");
  sel.innerHTML = '<option value="">Pilih Petugas</option>';

  data.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p.id_petugas;
    opt.textContent = p.id_petugas + " - " + p.nama;
    sel.appendChild(opt);
  });
}

loadPetugas();

// ================= SCAN =================
function startScan() {
  const petugasId = document.getElementById("petugas").value;
  if (!petugasId) {
    alert("Pilih petugas dulu");
    return;
  }

  const html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qrText => {
      html5QrCode.stop();
      document.getElementById("status").innerText = "QR terbaca: " + qrText;

      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        let jarak = 0;
        let valid = false;

        try {
          const { data: posKerja, error } = await db
            .from("pos_kerja")
            .select("lat_pos,long_pos,toleransi")
            .eq("id_pos", qrText)
            .single();

          if (!error && posKerja) {
            jarak = hitungJarak(lat, lon, posKerja.lat_pos, posKerja.long_pos);
            valid = jarak <= posKerja.toleransi;
          }
        } catch (e) {
          console.error(e);
        }

        const { error: insertError } = await db.from("log_scan").insert({
          waktu_scan: new Date().toISOString(),
          id_petugas: petugasId,
          id_pos: qrText,
          lat_scan: lat,
          long_scan: lon,
          jarak: jarak,
          valid: valid
        });

        if (insertError) {
          alert("Gagal simpan: " + insertError.message);
          console.error(insertError);
        } else {
          document.getElementById("status").innerText =
            "Scan tersimpan | Jarak: " + jarak.toFixed(1) + " m | Valid: " + valid;
        }

      }, err => {
        alert("GPS gagal: " + err.message);
      });

    },
    err => console.warn(err)
  );
}
</script>

</body>
</html>
