<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scan Pos Kerja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: Arial; padding: 20px }
    select, button { width: 100%; padding: 10px; margin: 10px 0 }
    #reader { width: 100% }
  </style>
</head>

<body>

<h2>Scan Pos Kerja</h2>

<select id="petugas"></select>

<button onclick="startScan()">Scan QR</button>

<div id="reader"></div>
<p id="status"></p>

<script>
const SUPABASE_URL = "https://jaiemnaqapcvmvvwqpct.supabase.co";
const SUPABASE_KEY = "sb_publishable_v1Nt74_3aNhVJKSY8v5I7Q_0OSjAb9C";

const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function hitungJarak(lat1, lon1, lat2, lon2) {
  const R = 6371000; // meter
  const toRad = x => x * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}

  
// Load petugas
async function loadPetugas() {
  const { data, error } = await db
    .from("petugas")
    .select("id_petugas,nama")
    .eq("status", "Aktif");

  if (error) {
    alert(error.message);
    return;
  }

  const sel = document.getElementById("petugas");
  data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id_petugas;
    o.text = p.id_petugas + " - " + p.nama;
    sel.add(o);
  });
}
loadPetugas();

function startScan() {
  const html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    async qrText => {
      html5QrCode.stop();
      document.getElementById("status").innerText = "QR terbaca: " + qrText;

      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

  const { data: pos, error: posError } = await db
  .from("pos_kerja")
  .select("lat_pos,long_pos,toleransi")
  .eq("id_pos", qrText)
  .single();

if (posError) {
  alert("Pos kerja tidak ditemukan");
  return;
}

const jarak = hitungJarak(
  lat,
  lon,
  pos.lat_pos,
  pos.long_pos
);

const valid = jarak <= pos.toleransi;

const { error } = await db.from("log_scan").insert({
  waktu_scan: new Date().toISOString(),
  id_petugas: document.getElementById("petugas").value,
  id_pos: qrText,
  lat_scan: lat,
  long_scan: lon,
  jarak: jarak,
  valid: valid
});


if (error) {
  alert("Gagal simpan: " + error.message);
  console.error(error);
} else {
  document.getElementById("status").innerText = "Scan tersimpan";
}



        document.getElementById("status").innerText = "Scan tersimpan";
      });
    }
  );
}
</script>

</body>
</html>
